<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta http-equiv="refresh" content="60">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Painel da Frota</title>

<style>
    body {
        font-family: Arial, sans-serif;
        background: #111;
        color: #fff;
        margin: 0;
        padding: 0;
        text-align: center;
    }

    h1 {
        margin-top: 10px;
    }

    table {
        width: 95%;
        margin: 20px auto;
        border-collapse: collapse;
        font-size: 22px;
    }

    th, td {
        border: 1px solid #444;
        padding: 10px;
    }

    th {
        background: #333;
    }

    /* Cancelado ‚Äì pisca */
    .cancelado {
        background: rgba(255, 0, 0, 0.5);
        animation: blink 1s infinite;
    }

    @keyframes blink {
        50% { background: rgba(255, 0, 0, 0.1); }
    }
</style>

</head>
<body>

<h1>üöó Painel da Frota ‚Äì Tempo Real</h1>

<div id="painel"></div>
<div id="agenda"></div>
<div id="agendaSocial"></div>

<script>
/* ============================================================
   FUN√á√ÉO PARA FORMATAR DATAS E HOR√ÅRIOS DO GOOGLE SHEETS
   ============================================================ */
function formatarGoogleDate(value) {
    if (typeof value !== "string" || !value.startsWith("Date(")) {
        return value;
    }

    const match = value.match(/Date\((\d+),(\d+),(\d+),(\d+),(\d+),(\d+)\)/);
    if (!match) return value;

    let [_, ano, mes, dia, hora, min, seg] = match.map(Number);

    mes += 1; // ajustar m√™s do Google

    // DATA REAL
    if (!(ano === 1899 && dia === 30)) {
        return `${String(dia).padStart(2, "0")}/${String(mes).padStart(2, "0")}/${ano}`;
    }

    // SOMENTE HORA
    return `${String(hora).padStart(2, "0")}:${String(min).padStart(2, "0")}`;
}

/* ============================================================
   FUN√á√ÉO PARA BUSCAR E EXIBIR TABELA
   ============================================================ */
async function carregarTabela(aba, elementoDestino) {
    try {
        const url = `https://docs.google.com/spreadsheets/d/1Ch3AjQ0MDo4WuQWFDR3r8nZrHb4yQkSLOtT5_QgxT6E/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(aba)}&nocache=${Date.now()}`;

        const res = await fetch(url);
        let texto = await res.text();

        texto = texto.replace("/*O_o*/", "").replace("google.visualization.Query.setResponse(", "").replace(/;\s*$/, "");

        const json = JSON.parse(texto);

        let html = `<h2>${aba}</h2><table><tr>`;

        json.table.cols.forEach(col => {
            html += `<th>${col.label}</th>`;
        });

        html += `</tr>`;

        json.table.rows.forEach(linha => {
            const status = linha.c.map(c => c?.v || "").join(" ").toLowerCase();
            const classe = status.includes("cancel") ? "cancelado" : "";

            html += `<tr class="${classe}">`;

            linha.c.forEach(c => {
                const valor = c ? formatarGoogleDate(c.v) : "";
                html += `<td>${valor}</td>`;
            });

            html += `</tr>`;
        });

        html += `</table>`;

        document.getElementById(elementoDestino).innerHTML = html;

    } catch (e) {
        document.getElementById(elementoDestino).innerHTML =
            `<p style="color:red">Erro ao carregar a aba ${aba}</p>`;
        console.error(e);
    }
}

/* ============================================================
   ATUALIZA√á√ÉO AUTOM√ÅTICA
   ============================================================ */
function atualizarTudo() {
    carregarTabela("Painel", "painel");
    carregarTabela("Agenda do Dia", "agenda");
    carregarTabela("Agenda Servi√ßo Social", "agendaSocial");
}

atualizarTudo();
setInterval(atualizarTudo, 60000);
</script>

</body>
</html>
